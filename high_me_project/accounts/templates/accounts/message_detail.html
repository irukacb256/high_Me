{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
        /* ヘッダー・フッター分を引く */
        max-width: 800px;
        margin: 0 auto;
        background-color: #f8f9fa;
    }

    .chat-header {
        background-color: #fff;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message-bubble {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        position: relative;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    /* 自分のメッセージ (ワーカー) */
    .message-mine {
        align-self: flex-end;
        background-color: #007bff;
        /* Primary Blue */
        color: white;
        border-bottom-right-radius: 2px;
    }

    /* 相手のメッセージ (店舗) */
    .message-other {
        align-self: flex-start;
        background-color: #fff;
        border: 1px solid #e9ecef;
        color: #333;
        border-bottom-left-radius: 2px;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.8;
    }

    .message-mine .message-time {
        text-align: right;
    }

    .message-other .message-time {
        text-align: left;
    }

    .chat-input-area {
        background-color: #fff;
        border-top: 1px solid #dee2e6;
        padding: 10px;
        position: sticky;
        bottom: 0;
    }

    .sender-name {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 2px;
        margin-left: 2px;
    }

    .date-separator {
        text-align: center;
        margin: 15px 0;
        position: relative;
    }

    .date-separator span {
        background-color: #e9ecef;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        color: #6c757d;
    }
</style>

<div class="chat-container">
    <!-- ヘッダー -->
    <div class="chat-header d-flex align-items-center justify-content-between p-3 bg-white border-bottom">
        <a href="{% url 'worker_message_list' %}" class="text-decoration-none text-dark">
            <i class="fa-solid fa-chevron-left fa-lg"></i>
        </a>
        <div class="fw-bold fs-5">
            {{ application.job_posting.template.store.store_name }}
        </div>
        <div style="width: 20px;">
            <!-- 右側のバランス調整用、必要なら情報アイコンなど -->
            <i class="fa-solid fa-circle-info text-secondary fa-lg"></i>
        </div>
    </div>

    <!-- メッセージエリア (top padding調整) -->
    <div class="chat-messages" id="chatMessages">
        {% if not messages %}
        <div class="text-center text-muted my-5">
            <small>まだメッセージはありません。<br>不明点があれば質問してみましょう。</small>
        </div>
        {% endif %}

        {% for msg in messages %}
        {% ifchanged msg.created_at|date:"Y-m-d" %}
        <div class="date-separator">
            <span>{{ msg.created_at|date:"n月j日 (D)" }}</span>
        </div>
        {% endifchanged %}

        {% if msg.sender == user %}
        <!-- 自分 -->
        <div class="message-mine message-bubble">
            {{ msg.content|linebreaksbr }}
            <div class="message-time">{{ msg.created_at|date:"H:i" }}</div>
        </div>
        {% else %}
        <!-- 相手 -->
        <div class="align-self-start">
            <div class="sender-name">{{ msg.sender.businessprofile.company_name|default:"店舗" }}</div>
            <div class="message-other message-bubble">
                {{ msg.content|linebreaksbr }}
                <div class="message-time">{{ msg.created_at|date:"H:i" }}</div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- 入力エリア -->
    <div class="chat-input-area">
        <form method="post" class="d-flex gap-2 align-items-center"
            style="background: #f0f0f0; padding: 10px; border-radius: 0;">
            {% csrf_token %}
            <div class="flex-grow-1 position-relative">
                <textarea name="content" class="form-control border-0" rows="1" placeholder="メッセージを入力"
                    style="resize: none; border-radius: 20px; padding: 10px 15px; font-size: 1rem; box-shadow: none;"></textarea>
            </div>
            <button type="submit" class="btn btn-link text-primary fw-bold text-decoration-none p-0"
                style="white-space: nowrap;">
                送信
            </button>
        </form>
    </div>
</div>

<script>
    // 自動スクロール
    window.onload = function () {
        var chatDiv = document.getElementById("chatMessages");
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
</script>
{% endblock %}