{% extends 'base_main.html' %}
{% block content %}
<style>
    .reward-container {
        background: #f8f8f8;
        min-height: 100vh;
        padding: 20px;
    }

    .header-title {
        font-weight: bold;
        margin-bottom: 20px;
        text-align: left;
    }

    .wallet-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .wallet-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .wallet-amount {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* ボタン: 引き出す - 非活性ならグレー */
        {
        % if balance <=0 or not bank_account %
    }

    .btn-withdraw {
        background: #ccc;
        pointer-events: none;
    }

        {
        % else %
    }

    .btn-withdraw {
        background: #ccc;
        /* 画像ではグレーのようです (残高0のため？)。残高あればアクティブ色？一旦グレーベースで */
        /* もし残高ありなら赤にする？画像2は0円でグレー */
    }

        {
        % endif %
    }

    .btn-withdraw-style {
        display: block;
        text-align: center;
        padding: 12px;
        border-radius: 8px;
        font-weight: bold;
        color: white;
        text-decoration: none;
        background: #ddd;
        /* デフォルト */
    }

        {
        % if balance>0 and bank_account %
    }

    .btn-withdraw-style {
        background: #007AFF;
    }

        {
        % endif %
    }

    .alert-box {
        background: #FFF9E6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #FFEBA0;
    }

    .alert-title {
        color: #8F7600;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 5px;
    }

    .alert-text {
        font-size: 12px;
        color: #666;
        margin-bottom: 15px;
    }

    .btn-register {
        display: inline-block;
        border: 1px solid #E6CD50;
        color: #8F7600;
        background: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold;
        text-decoration: none;
    }

    .menu-list {
        background: white;
        border-radius: 10px;
    }

    .menu-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #f2f2f2;
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }

    .menu-item:last-child {
        border-bottom: none;
    }

    .menu-val {
        font-weight: normal;
        color: #888;
        font-size: 13px;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-box {
        background: white;
        width: 80%;
        max-width: 300px;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .modal-title {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .modal-btns {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn-modal-cancel {
        background: #eee;
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 13px;
    }

    .btn-modal-ok {
        background: #007AFF;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 13px;
    }
</style>

<div class="reward-container">
    <div class="header-title">
        <a href="{% url 'mypage' %}" style="color:black; margin-right:10px;"><i class="fa-solid fa-arrow-left"></i></a>
        報酬管理
    </div>

    <!-- ウォレット残高 -->
    <div class="wallet-card">
        <div class="wallet-label"><i class="fa-regular fa-credit-card"></i> ウォレット残高</div>
        <div class="wallet-amount">¥{{ balance }}</div>

        <!-- 振込申請ボタン -->
        {% if balance > 0 and bank_account %}
        <a href="{% url 'withdraw_application' %}" class="btn-withdraw-style">振り込み申請</a>
        {% else %}
        <div class="btn-withdraw-style" style="background:#ddd; cursor:not-allowed;">振り込み申請</div>
        {% endif %}
    </div>

    <!-- 銀行口座未登録アラート -->
    {% if not bank_account %}
    <div class="alert-box">
        <div class="alert-title"><i class="fa-solid fa-triangle-exclamation"></i> 振込先口座が未登録です</div>
        <div class="alert-text">
            ウォレット残高を引き出すための振込先口座を登録してください。
        </div>
        <!-- 登録ボタン (JS制御) -->
        <a href="#" class="btn-register" id="btn-register-bank">振込先口座を登録</a>
    </div>
    {% endif %}

    <!-- メニューリスト -->
    <div class="menu-list">
        {% if bank_account %}
        <a href="{% url 'bank_account_edit' %}" class="menu-item">
            <div>
                <i class="fa-solid fa-building-columns" style="margin-right:10px;"></i> 振込先口座
                <div style="font-size:12px; font-weight:normal; color:#666; margin-top:4px;">
                    {{ bank_account.bank_name }} {{ bank_account.account_number }}
                </div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:#ccc;"></i>
        </a>
        {% else %}
        <!-- 未登録時でもクリック可能にして、本人確認チェックを走らせる -->
        <a href="#" class="menu-item" id="btn-menu-bank">
            <span><i class="fa-solid fa-building-columns" style="margin-right:10px;"></i> 振込先口座</span>
            <span class="menu-val">未登録</span>
        </a>
        {% endif %}

        <a href="{% url 'wallet_history' %}" class="menu-item">
            <span><i class="fa-solid fa-clock-rotate-left" style="margin-right:10px;"></i> 入出金履歴</span>
            <i class="fa-solid fa-chevron-right" style="color:#ccc;"></i>
        </a>
    </div>

    <div style="text-align:right; margin-top:20px; font-size:12px;">
        <a href="#" style="color:#333;"><i class="fa-regular fa-circle-question"></i> 即時振り込み。給料日について</a>
    </div>

</div>

<!-- モーダル -->
<div class="modal-overlay" id="identity-modal">
    <div class="modal-box">
        <div class="modal-title">本人確認書類を登録しましょう</div>
        <p style="font-size:13px; text-align:left;">
            振込先口座を登録するには、本人確認が必要です。
        </p>
        <div class="modal-btns">
            <a href="#" class="btn-modal-cancel" id="modal-close">あとで</a>
            <a href="{% url 'verify_identity_select' %}" class="btn-modal-ok">登録する</a>
        </div>
    </div>
</div>

<script>
    const btnRegister = document.getElementById('btn-register-bank');
    const modal = document.getElementById('identity-modal');
    const btnClose = document.getElementById('modal-close');

    // Djangoテンプレート変数として本人確認状態を出力
    const isVerified = "{{ profile.is_identity_verified|yesno:'true,false' }}";

    function handleRegisterClick(e) {
        e.preventDefault();
        if (isVerified === 'true') {
            // 本人確認済み -> 口座登録画面へ
            window.location.href = "{% url 'bank_account_edit' %}";
        } else {
            // 未確認 -> モーダル表示
            modal.style.display = 'flex';
        }
    }

    if (btnRegister) {
        btnRegister.addEventListener('click', handleRegisterClick);
    }

    // メニュー側のボタン
    const btnMenuBank = document.getElementById('btn-menu-bank');
    if (btnMenuBank) {
        btnMenuBank.addEventListener('click', handleRegisterClick);
    }

    if (btnClose) {
        btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            modal.style.display = 'none';
        });
    }
</script>
{% endblock %}