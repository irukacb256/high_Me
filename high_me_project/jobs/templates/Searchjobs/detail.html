{% extends 'base_main.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    .detail-container {
        background: white;
        min-height: 100vh;
        padding-bottom: 120px;
        /* ボトムボタン用の余白 */
    }

    /* ヘッダー画像(カルーセル) */
    .header-img {
        width: 100%;
        height: 250px;
        background: #eee;
        position: relative;
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }

    .header-img::-webkit-scrollbar {
        display: none;
    }

    .header-img img {
        width: 100%;
        flex-shrink: 0;
        height: 100%;
        object-fit: cover;
        scroll-snap-align: start;
    }

    .header-img-placeholder {
        width: 100%;
        flex-shrink: 0;
        height: 100%;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .back-btn {
        position: absolute;
        top: 20px;
        left: 15px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* メイン情報 */
    .detail-body {
        padding: 20px 15px;
    }

    .category-text {
        font-size: 13px;
        color: #8E8E93;
        margin-bottom: 8px;
    }

    .job-title {
        font-size: 20px;
        font-weight: bold;
        line-height: 1.4;
        margin-bottom: 15px;
        color: #000;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #333;
        margin-bottom: 15px;
    }

    .info-row i {
        color: #8E8E93;
        width: 16px;
        text-align: center;
    }

    /* バッジエリア */
    .badge-area {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }

    .badge {
        font-size: 11px;
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 4px;
        color: white;
    }

    .badge-red {
        background: #FF3B30;
    }

    /* 報酬表示 */
    .payment-section {
        margin-bottom: 30px;
    }

    .total-amount {
        font-size: 32px;
        font-weight: bold;
        color: #000;
        margin-bottom: 5px;
    }

    .breakdown-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
        margin-bottom: 4px;
    }

    .breakdown-row i {
        color: #8E8E93;
        width: 16px;
    }

    /* セクションタイトル */
    .section-title {
        font-weight: bold;
        font-size: 17px;
        margin: 40px 0 15px;
        color: #000;
    }

    /* 待遇アイコン */
    .treatment-list {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .treatment-item {
        width: 65px;
        text-align: center;
        font-size: 10px;
        color: #8E8E93;
    }

    .treatment-icon {
        width: 60px;
        height: 60px;
        background: #F2F2F7;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #8E8E93;
        margin: 0 auto 6px;
    }

    .content-text {
        font-size: 15px;
        color: #333;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    /* アコーディオン(書類) */
    .accordion {
        border-top: 1px solid #F2F2F7;
        border-bottom: 1px solid #F2F2F7;
        margin: 20px 0;
    }

    .accordion-header {
        padding: 18px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
    }

    .accordion-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: bold;
        font-size: 15px;
    }

    .accordion-body {
        display: none;
        padding-bottom: 18px;
        font-size: 14px;
        color: #666;
    }

    /* マップ */
    .map-placeholder {
        width: 100%;
        height: 180px;
        background: #F2F2F7;
        border-radius: 12px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8E8E93;
        overflow: hidden;
    }

    .map-placeholder img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* 店舗詳細セクション */
    .store-info-box {
        text-align: center;
        padding: 40px 0;
        border-top: 1px solid #F2F2F7;
    }

    .store-logo {
        width: 80px;
        height: 80px;
        background: #F2F2F7;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: #C7C7CC;
    }

    .store-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 15px;
    }

    .btn-outline {
        display: inline-block;
        padding: 8px 20px;
        border: 1px solid #E5E5EA;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        color: #333;
        text-decoration: none;
    }

    /* ボトム固定ボタン - 浮いているスタイル */
    .fixed-footer {
        position: fixed;
        bottom: 75px;
        /* ボトムナビの高さに合わせる */
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 430px;
        /* スマホサイズに制限 */
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #eee;
        padding: 10px 15px;
        box-sizing: border-box;
        z-index: 1001;
        display: flex;
        /* 横並び */
        align-items: center;
        gap: 10px;
    }

    .btn-fav {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: white;
        border: 1px solid #E5E5EA;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #C7C7CC;
        cursor: pointer;
        flex-shrink: 0;
        /* 縮小しない */
    }

    .btn-fav.active {
        color: #E0245E;
        border-color: #E0245E;
        background: #FFF0F5;
    }

    .btn-apply {
        flex: 1;
        /* 残りの幅をすべて使う */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px;
        background: #007AFF;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        text-decoration: none;
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
    }

    .btn-verify {
        background: #FFD700;
        color: #000;
    }

    .btn-closed {
        background: #E5E5EA;
        color: #8E8E93;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* Kebab Menu Button */
    .kebab-btn {
        position: absolute;
        top: 20px;
        right: 15px;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        cursor: pointer;
        font-size: 20px;
        filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.3));
    }

    /* Bottom Sheet Overlay */
    .sheet-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
    }

    /* Bottom Sheet Menu */
    .sheet-menu {
        position: fixed;
        bottom: -100%;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 430px;
        /* Limit width for desktop */
        background: transparent;
        /* Container is transparent */
        z-index: 2001;
        transition: bottom 0.3s ease-out;
        padding: 10px;
        box-sizing: border-box;
    }

    .sheet-menu.active {
        bottom: 0;
    }

    .sheet-group {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .sheet-item {
        display: block;
        width: 100%;
        padding: 16px;
        text-align: center;
        font-size: 16px;
        color: #007AFF;
        background: transparent;
        border: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        cursor: pointer;
        text-decoration: none;
    }

    .sheet-item:last-child {
        border-bottom: none;
    }

    .sheet-item.text-red {
        color: #FF3B30;
    }

    .sheet-cancel {
        background: white;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        width: 100%;
        font-weight: bold;
        color: #007AFF;
        font-size: 16px;
        cursor: pointer;
    }
</style>

<div class="detail-container">
    <div class="header-img">
        {% if from_view == 'favorites' %}
        <a href="{% url 'favorites' %}" class="back-btn"><i class="fa-solid fa-chevron-left"></i></a>
        {% else %}
        <a href="{% url 'index' %}" class="back-btn"><i class="fa-solid fa-chevron-left"></i></a>
        {% endif %}

        <!-- Kebab Menu Button -->
        <div class="kebab-btn" onclick="openBottomSheet()">
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </div>

        {% for photo in job.template.photos.all %}
        <img src="{{ photo.image.url }}" alt="求人画像">
        {% empty %}
        <div class="header-img-placeholder">
            <img src="https://via.placeholder.com/400x250?text={{ job.template.occupation }}" alt="求人画像">
        </div>
        {% endfor %}
    </div>

    <div class="detail-body">
        <div class="category-text">{{ job.template.industry }} / {{ job.template.occupation }}</div>
        <h1 class="job-title">{{ job.title }}</h1>

        <div class="info-row">
            <i class="fa-regular fa-clock"></i>
            <div>
                {{ job.work_date|date:"Y年n月j日(D)" }} {{ job.start_time|time:"H:i" }}〜{{ job.end_time|time:"H:i" }} (休憩{{
                job.break_duration }}分)
            </div>
        </div>

        <div class="badge-area">
            {% if job.is_urgent %}
            <div class="badge badge-red">あと少しで募集締め切り</div>
            {% endif %}
            <div class="badge badge-red">募集人数 {{ job.matched_count }}/{{ job.recruitment_count }}人</div>
        </div>

        <div class="payment-section">
            <div class="total-amount">¥{{ job.total_payment|default:"2,565" }}</div>
            <div class="breakdown-row">
                <i class="fa-solid fa-yen-sign"></i>
                <div>時給 ¥{{ job.hourly_wage|default:"1,140" }}</div>
            </div>
            <div class="breakdown-row">
                <i class="fa-solid fa-train"></i>
                <div>交通費{% if job.transportation_fee > 0 %} ¥{{ job.transportation_fee }}{% else %}支給なし{% endif %}</div>
            </div>
        </div>

        <div class="section-title">待遇</div>
        <div class="treatment-list">
            {% if job.template.has_unexperienced_welcome %}
            <div class="treatment-item">
                <div class="treatment-icon"><i class="fa-solid fa-user-plus"></i></div>
                未経験者歓迎
            </div>
            {% endif %}
            {% if job.template.has_meal %}
            <div class="treatment-item">
                <div class="treatment-icon"><i class="fa-solid fa-utensils"></i></div>
                まかないあり
            </div>
            {% endif %}
            {% if job.template.has_clothing_free %}
            <div class="treatment-item">
                <div class="treatment-icon"><i class="fa-solid fa-shirt"></i></div>
                服装自由
            </div>
            {% endif %}
            {% if job.template.has_transportation_allowance or job.transportation_fee > 0 %}
            <div class="treatment-item">
                <div class="treatment-icon"><i class="fa-solid fa-train"></i></div>
                交通費支給
            </div>
            {% endif %}
        </div>

        <div class="section-title">業務内容</div>
        <div class="content-text">{{ job.template.work_content }}</div>

        {% if job.template.precautions %}
        <div class="section-title">注意事項</div>
        <div class="content-text">{{ job.template.precautions }}</div>
        {% endif %}

        <div class="section-title">持ち物</div>
        <div class="content-text">{{ job.template.belongings|default:"特になし" }}</div>

        <div class="section-title">働くための条件</div>
        <div class="content-text">{{ job.template.requirements|default:"特になし" }}</div>

        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion('docs-body', 'docs-icon')">
                <div class="accordion-title">
                    <i class="fa-regular fa-file-lines"></i> 業務に関する書類
                </div>
                <i class="fa-solid fa-chevron-down" id="docs-icon" style="color: #C7C7CC; font-size: 14px;"></i>
            </div>
            <div id="docs-body" class="accordion-body">
                {% if job.template.manual_pdf %}
                <a href="{{ job.template.manual_pdf.url }}" target="_blank"
                    style="color: #007AFF; text-decoration: none;">
                    <i class="fa-solid fa-file-pdf"></i> マニュアルを確認する
                </a>
                {% else %}
                書類はありません。
                {% endif %}
            </div>
        </div>

        <div class="section-title">働く場所</div>
        <div id="job-detail-map" class="map-placeholder">
            {% if not job.template.store.latitude or not job.template.store.longitude %}
            <div style="padding: 20px; text-align: center; color: #999;">
                <i class="fa-solid fa-map-location-dot" style="font-size: 32px; margin-bottom: 10px;"></i><br>
                位置情報が登録されていません
            </div>
            {% endif %}
        </div>
        <div class="content-text">{{ job.template.store.prefecture }}{{ job.template.store.city }}{{
            job.template.store.address_line }}</div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const lat = "{{ job.template.store.latitude }}";
                const lng = "{{ job.template.store.longitude }}";

                if (lat && lng) {
                    const map = L.map('job-detail-map', {
                        zoomControl: false,
                        scrollWheelZoom: false,
                    }).setView([parseFloat(lat), parseFloat(lng)], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(map);

                    L.marker([parseFloat(lat), parseFloat(lng)]).addTo(map);

                    // タップ（クリック）でズーム制御などを有効にする（オプション）
                    map.on('click', function () {
                        if (map.scrollWheelZoom.enabled()) {
                            map.scrollWheelZoom.disable();
                        } else {
                            map.scrollWheelZoom.enable();
                        }
                    });
                }
            });
        </script>

        {% if job.template.access %}
        <div class="section-title">アクセス</div>
        <div class="content-text">{{ job.template.access }}</div>
        {% endif %}

        <div class="store-info-box">
            <div class="store-logo">
                <i class="fa-solid fa-store"></i>
            </div>
            <div class="store-name">{{ job.template.store.store_name }}</div>
            <a href="{% url 'store_profile' job.template.store.id %}" class="btn-outline">この店舗の募集状況</a>
        </div>
    </div>
</div>

<!-- Bottom Sheet & Overlay -->
<div class="sheet-overlay" id="sheet-overlay" onclick="closeBottomSheet()"></div>
<div class="sheet-menu" id="sheet-menu">
    <div class="sheet-group">
        <div class="sheet-item" onclick="alert('シェア機能は未実装です')">この募集をシェア</div>
        <div class="sheet-item text-red" onclick="alert('通知ミュート機能は未実装です')">この店舗の通知をミュート</div>
        <div class="sheet-item text-red" onclick="alert('通報機能は未実装です')">募集内容を通報</div>
    </div>
    <div class="sheet-cancel" onclick="closeBottomSheet()">キャンセル</div>
</div>

<!-- 固定ボタン -->
<div class="fixed-footer">
    <!-- ハートマーク -->
    <div class="btn-fav {% if is_favorited %}active{% endif %}" onclick="toggleFav('{{ job.id }}', this)">
        <i class="fa-{% if is_favorited %}solid{% else %}regular{% endif %} fa-heart"></i>
    </div>

    <!-- 申し込みボタン -->
    {% if not user.is_authenticated %}
    <a href="{% url 'gate' %}" class="btn-apply">ログインして申し込む</a>
    {% elif not user.workerprofile.is_identity_verified %}
    <a href="{% url 'verify_identity_select' %}" class="btn-apply btn-verify">本人確認にすすむ</a>
    {% elif is_applied %}
    <div class="btn-apply btn-closed">申し込み済み</div>
    {% elif is_closed %}
    <div class="btn-apply btn-closed">募集を終了しました</div>
    {% else %}
    <a href="{% url 'apply_step_1' job.pk %}" class="btn-apply">申し込みにすすむ</a>
    {% endif %}
</div>

<script>
    function openBottomSheet() {
        document.getElementById('sheet-overlay').style.display = 'block';
        setTimeout(() => {
            document.getElementById('sheet-menu').classList.add('active');
        }, 10);
    }

    function closeBottomSheet() {
        document.getElementById('sheet-menu').classList.remove('active');
        setTimeout(() => {
            document.getElementById('sheet-overlay').style.display = 'none';
        }, 300);
    }

    function toggleAccordion(bodyId, iconId) {
        const body = document.getElementById(bodyId);
        const icon = document.getElementById(iconId);
        if (body.style.display === "block") {
            body.style.display = "none";
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            body.style.display = "block";
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    function toggleFav(jobId, btnElement) {
        fetch(`/favorites/toggle/job/${jobId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const icon = btnElement.querySelector('i');
                    if (data.is_favorited) {
                        btnElement.classList.add('active');
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                        icon.style.color = '#E0245E'; // ハートの色を赤くする
                    } else {
                        btnElement.classList.remove('active');
                        icon.classList.remove('fa-solid');
                        icon.classList.add('fa-regular');
                        icon.style.color = '#C7C7CC'; // 元の色に戻す
                    }
                }
            });
    }
</script>

{% endblock %}