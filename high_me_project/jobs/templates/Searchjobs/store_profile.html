{% extends 'base_main.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
    /* 全体レイアウト */
    .store-profile-container {
        padding-bottom: 80px;
        background: #fff;
    }

    /* ヘッダー周り */
    .store-header {
        position: relative;
        text-align: center;
        padding: 20px 20px 30px;
        border-bottom: 1px solid #eee;
    }

    .back-btn-absolute {
        position: absolute;
        left: 20px;
        top: 20px;
        font-size: 20px;
        color: #333;
        text-decoration: none;
    }

    .store-logo-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 15px;
        display: block;
        background: #eee;
    }

    .store-name-large {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* お気に入りボタン（店舗用） */
    .btn-fav-store {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 14px;
        font-weight: bold;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #eee;
    }

    .btn-fav-store.active {
        background: #FFF0F5;
        /* 薄いピンク */
        color: #E0245E;
        border-color: #E0245E;
    }

    .btn-fav-store:not(.active) {
        background: #f5f5f5;
        color: #666;
    }

    /* 求人リストセクション */
    .job-list-section {
        padding: 20px;
        background: #f9f9f9;
        min-height: 400px;
    }

    .date-header {
        font-size: 16px;
        font-weight: bold;
        margin: 20px 0 10px;
        color: #333;
    }

    /* 求人カード (簡易版 - index.htmlと合わせる) */
    .job-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        position: relative;
    }

    .job-image {
        width: 120px;
        height: auto;
        object-fit: cover;
        position: relative;
    }

    .job-content {
        padding: 12px;
        flex: 1;
    }

    .job-title {
        font-size: 14px;
        font-weight: bold;
        line-height: 1.4;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .job-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
    }

    .job-salary {
        font-size: 15px;
        font-weight: bold;
        color: #333;
        text-align: right;
    }

    /* 求人カード内のお気に入りボタン */
    .btn-fav-job {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #ccc;
        font-size: 16px;
        z-index: 10;
        border: 1px solid #eee;
    }

    .btn-fav-job.active {
        color: #E0245E;
        /* ハートの色 */
    }
</style>

<div class="store-profile-container">
    <!-- ヘッダーエリア -->
    <div class="store-header">
        <a href="javascript:history.back()" class="back-btn-absolute"><i class="fa-solid fa-arrow-left"></i></a>

        <!-- 店舗ロゴがあれば表示、なければアイコン -->
        {% if store.image %}
        <img src="{{ store.image.url }}" class="store-logo-large">
        {% else %}
        <div class="store-logo-large"
            style="display:flex; align-items:center; justify-content:center; background:#eee; font-size:40px; color:#aaa;">
            <i class="fa-solid fa-store"></i>
        </div>
        {% endif %}

        <div class="store-name-large">{{ store.store_name }}</div>

        <!-- お気に入りボタン -->
        <div id="store-fav-btn" class="btn-fav-store {% if is_favorited %}active{% endif %}"
            onclick="toggleStoreFav({{ store.id }})">
            <i class="fa-{% if is_favorited %}solid{% else %}regular{% endif %} fa-heart"></i>
            <span>{% if is_favorited %}お気に入り済み{% else %}この店舗をお気に入りにする{% endif %}</span>
        </div>
    </div>

    <!-- 求人リストエリア -->
    <div class="job-list-section">
        {% if job_postings %}
        {% regroup job_postings by work_date as date_list %}

        {% for date_group in date_list %}
        <div class="date-header">{{ date_group.grouper|date:"n月j日(D)" }}</div>

        {% for job in date_group.list %}
        <div class="job-card" onclick="location.href='{% url 'job_detail' job.id %}'" style="cursor:pointer;">
            <div class="job-image" style="background-color: {{ job.image_color|default:'#eee' }};">
                <!-- 画像があれば表示 -->
                {% if job.template.photos.first %}
                <img src="{{ job.template.photos.first.image.url }}" style="width:100%; height:100%; object-fit:cover;">
                {% endif %}

                <!-- ここにも求人のお気に入りボタンを置く -->
                <div class="btn-fav-job {% if job.id in user_fav_job_ids %}active{% endif %}"
                    onclick="event.stopPropagation(); toggleJobFav({{ job.id }}, this)">
                    <i class="fa-{% if job.id in user_fav_job_ids %}solid{% else %}regular{% endif %} fa-heart"></i>
                </div>
            </div>
            <div class="job-content">
                <div class="job-title">{{ job.title }}</div>
                <div class="job-meta">
                    {{ job.work_date|date:"n月j日" }}<br>
                    {{ job.start_time|date:"H:i" }}～{{ job.end_time|date:"H:i" }}<br>
                    {{ job.template.address|truncatechars:12 }}
                </div>
                <div class="job-salary">¥{{ job.total_payment|intcomma }}</div>
            </div>
        </div>
        {% endfor %}
        {% endfor %}

        {% else %}
        <div style="text-align:center; padding:40px; color:#999;">
            現在募集中の求人はありません
        </div>
        {% endif %}
    </div>
</div>

<script>
    // 店舗お気に入りトグル
    function toggleStoreFav(storeId) {
        fetch(`/favorites/toggle/store/${storeId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const btn = document.getElementById('store-fav-btn');
                    const icon = btn.querySelector('i');
                    const text = btn.querySelector('span');

                    if (data.is_favorited) {
                        btn.classList.add('active');
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                        text.innerText = "お気に入り済み";
                    } else {
                        btn.classList.remove('active');
                        icon.classList.remove('fa-solid');
                        icon.classList.add('fa-regular');
                        text.innerText = "この店舗をお気に入りにする";
                    }
                }
            });
    }

    // 求人お気に入りトグル
    function toggleJobFav(jobId, btnElement) {
        fetch(`/favorites/toggle/job/${jobId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const icon = btnElement.querySelector('i');
                    if (data.is_favorited) {
                        btnElement.classList.add('active');
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                    } else {
                        btnElement.classList.remove('active');
                        icon.classList.remove('fa-solid');
                        icon.classList.add('fa-regular');
                    }
                }
            });
    }
</script>
{% endblock %}