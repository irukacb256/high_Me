import os
import django
import sys

# Django Setup
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from business.models import Store, JobTemplate

# 各市区町村の精密座標データ (一部抜粋・網羅)
MUNI_COORDS = {
    "茨城県": {
        "水戸市": (36.3665, 140.4710), "日立市": (36.5992, 140.6515), "土浦市": (36.0783, 140.2043),
        "古河市": (36.1846, 139.7025), "石岡市": (36.1900, 140.2876), "結城市": (36.3054, 139.8766),
        "龍ケ崎市": (35.9116, 140.1823), "下妻市": (36.1845, 139.9674), "常総市": (36.0235, 139.9936),
        "常陸太田市": (36.5383, 140.5310), "高萩市": (36.7191, 140.7167), "北茨城市": (36.8019, 140.7510),
        "笠間市": (36.3453, 140.3044), "取手市": (35.9114, 140.0505), "牛久市": (35.9794, 140.1495),
        "つくば市": (36.0835, 140.0766), "ひたちなか市": (36.3966, 140.5347), "鹿嶋市": (35.9658, 140.6448),
        "潮来市": (35.9471, 140.5554), "守谷市": (35.9514, 139.9754), "常陸大宮市": (36.5426, 140.4109),
        "那珂市": (36.4575, 140.4869), "筑西市": (36.3071, 139.9831), "坂東市": (36.0487, 139.8883),
        "稲敷市": (35.9565, 140.3239), "かすみがうら市": (36.0945, 140.3307), "桜川市": (36.3273, 140.0904),
        "神栖市": (35.8900, 140.6645), "行方市": (35.9904, 140.4890), "鉾田市": (36.1586, 140.5165),
        "つくばみらい市": (35.9630, 140.0370), "小美玉市": (36.2393, 140.3526), "茨城町": (36.2869, 140.4245),
        "大洗町": (36.3134, 140.5750), "城里町": (36.4794, 140.3762), "東海村": (36.4729, 140.5663),
        "大子町": (36.7681, 140.3553), "美浦村": (36.0046, 140.3019), "阿見町": (36.0308, 140.2148),
        "河内町": (35.8848, 140.2445), "八千代町": (36.1816, 139.8911), "五霞町": (36.1264, 139.7441),
        "境町": (36.1070, 139.7915), "利根町": (35.8569, 140.1294)
    },
    "栃木県": {
        "宇都宮市": (36.5551, 139.8828), "足利市": (36.3402, 139.4497), "栃木市": (36.3824, 139.7341),
        "佐野市": (36.3086, 139.5931), "鹿沼市": (36.5671, 139.7450), "日光市": (36.7199, 139.6982),
        "小山市": (36.3147, 139.8001), "真岡市": (36.4404, 140.0134), "大田原市": (36.8715, 140.0174),
        "矢板市": (36.8067, 139.9241), "那須塩原市": (36.9617, 140.0461), "さくら市": (36.6853, 139.9665),
        "那須烏山市": (36.6569, 140.1514), "下野市": (36.3872, 139.8420), "上三川町": (36.4393, 139.9099),
        "益子町": (36.4674, 140.0934), "茂木町": (36.5321, 140.1876), "市貝町": (36.5433, 140.1020),
        "芳賀町": (36.5483, 140.0582), "壬生町": (36.4271, 139.8039), "野木町": (36.2333, 139.7408),
        "塩谷町": (36.7776, 139.8506), "高根沢町": (36.6310, 139.9867), "那須町": (37.0197, 140.1210),
        "那珂川町": (36.7617, 140.1301)
    },
    "群馬県": {
        "前橋市": (36.3895, 139.0634), "高崎市": (36.3219, 139.0033), "桐生市": (36.4055, 139.3307),
        "伊勢崎市": (36.3114, 139.1968), "太田市": (36.2911, 139.3755), "沼田市": (36.6461, 139.0442),
        "館林市": (36.2448, 139.5420), "渋川市": (36.4895, 139.0004), "藤岡市": (36.2585, 139.0744),
        "富岡市": (36.2599, 138.8899), "安中市": (36.3264, 138.8873), "みどり市": (36.3948, 139.2811),
        "榛東村": (36.4386, 138.9671), "吉岡町": (36.4475, 139.0098), "上野村": (36.0831, 138.7774),
        "神流町": (36.1161, 138.9170), "下仁田町": (36.2124, 138.7891), "南牧村": (36.1585, 138.7114),
        "甘楽町": (36.2430, 138.9217), "中之条町": (36.5899, 138.8410), "長野原町": (36.5524, 138.6375),
        "嬬恋村": (36.5169, 138.5302), "草津町": (36.6208, 138.5961), "高山村": (36.6209, 138.9434),
        "東吾妻町": (36.5713, 138.8255), "片品村": (36.7725, 139.2252), "川場村": (36.6947, 139.1065),
        "昭和村": (36.6398, 139.0659), "みなかみ町": (36.6787, 138.9991), "玉村町": (36.3044, 139.1149),
        "板倉町": (36.2230, 139.6103), "明和町": (36.2113, 139.5342), "千代田町": (36.2178, 139.4424),
        "大泉町": (36.2479, 139.4049), "邑楽町": (36.2524, 139.4623)
    },
    "東京都": {
        "千代田区": (35.6940, 139.7536), "中央区": (35.6707, 139.7719), "港区": (35.6581, 139.7516),
        "新宿区": (35.6938, 139.7035), "文京区": (35.7081, 139.7522), "台東区": (35.7126, 139.7800),
        "墨田区": (35.7107, 139.8015), "江東区": (35.6729, 139.8174), "品川区": (35.6092, 139.7302),
        "目黒区": (35.6415, 139.6982), "大田区": (35.5613, 139.7161), "世田谷区": (35.6466, 139.6532),
        "渋谷区": (35.6618, 139.7041), "中野区": (35.7074, 139.6638), "杉並区": (35.6996, 139.6364),
        "豊島区": (35.7261, 139.7166), "北区": (35.7528, 139.7335), "荒川区": (35.7361, 139.7834),
        "板橋区": (35.7512, 139.7092), "練馬区": (35.7356, 139.6517), "足立区": (35.7757, 139.8045),
        "葛飾区": (35.7436, 139.8472), "江戸川区": (35.7067, 139.8684), "八王子市": (35.6663, 139.3158),
        "立川市": (35.7140, 139.4078), "武蔵野市": (35.7178, 139.5663), "三鷹市": (35.6835, 139.5596),
        "青梅市": (35.7880, 139.2758), "府中市": (35.6690, 139.4777), "昭島市": (35.7058, 139.3535),
        "調布市": (35.6506, 139.5407), "町田市": (35.5466, 139.4386), "小金井市": (35.6995, 139.5030),
        "小平市": (35.7286, 139.4775), "日野市": (35.6713, 139.3949), "東村山市": (35.7546, 139.4685),
        "国分寺市": (35.7103, 139.4632), "国立市": (35.6839, 139.4414), "福生市": (35.7385, 139.3269),
        "狛江市": (35.6349, 139.5787), "東大和市": (35.7454, 139.4266), "清瀬市": (35.7858, 139.5264),
        "東久留米市": (35.7580, 139.5297), "武蔵村山市": (35.7555, 139.3951), "多摩市": (35.6264, 139.4475),
        "稲城市": (35.6433, 139.5074), "羽村市": (35.7726, 139.3333), "あきる野市": (35.7372, 139.2639),
        "西東京市": (35.7347, 139.5403)
    },
    "神奈川県": {
        "横浜市": (35.4475, 139.6425), "川崎市": (35.5308, 139.7029), "相模原市": (35.5714, 139.3736),
        "横須賀市": (35.2815, 139.6722), "平塚市": (35.3338, 139.3491), "鎌倉市": (35.3192, 139.5467),
        "藤沢市": (35.3389, 139.4894), "小田原市": (35.2556, 139.1594), "茅ヶ崎市": (35.3338, 139.4058),
        "逗子市": (35.2954, 139.5804), "三浦市": (35.1425, 139.6191), "秦野市": (35.3752, 139.2275),
        "厚木市": (35.4411, 139.3625), "大和市": (35.4878, 139.4614), "伊勢原市": (35.4022, 139.3142),
        "海老名市": (35.4469, 139.3936), "座間市": (35.485, 139.4161), "南足柄市": (35.3167, 139.1),
        "綾瀬市": (35.4338, 139.4319), "葉山町": (35.2758, 139.5806), "寒川町": (35.3675, 139.3872),
        "大磯町": (35.3115, 139.3106), "二宮町": (35.3006, 139.2567), "中井町": (35.3338, 139.1669),
        "大井町": (35.352, 139.1169), "松田町": (35.3833, 139.1), "山北町": (35.4, 139.0169),
        "開成町": (35.3338, 139.1), "箱根町": (35.2333, 139.0333), "真鶴町": (35.15, 139.1333),
        "湯河原町": (35.15, 139.0667), "愛川町": (35.5333, 139.3167), "清川村": (35.4833, 139.2833)
    },
    "山梨県": {
        "甲府市": (35.6623, 138.5682), "富士吉田市": (35.4875, 138.8079), "都留市": (35.5517, 138.9055),
        "山梨市": (35.6934, 138.6870), "大月市": (35.6105, 138.9400), "韮崎市": (35.7088, 138.4462),
        "南アルプス市": (35.6084, 138.4650), "北杜市": (35.7765, 138.4238), "甲斐市": (35.6863, 138.4873),
        "笛吹市": (35.6474, 138.6400), "上野原市": (35.6303, 139.1086), "甲州市": (35.7043, 138.7294),
        "中央市": (35.5996, 138.5173), "市川三郷町": (35.5653, 138.5024), "早川町": (35.4129, 138.3628),
        "身延町": (35.4675, 138.4425), "南部町": (35.2424, 138.4861), "富士川町": (35.5612, 138.4614),
        "昭和町": (35.6279, 138.5351), "道志村": (35.5280, 139.0334), "西桂町": (35.5241, 138.8469),
        "忍野村": (35.4601, 138.8479), "山中湖村": (35.4106, 138.8609), "鳴沢村": (35.4814, 138.7064),
        "富士河口湖町": (35.4973, 138.7551), "小菅村": (35.7601, 138.9402), "丹波山村": (35.7897, 138.9222)
    },
    "長野県": {
        "長野市": (36.6486, 138.1942), "松本市": (36.2380, 137.9720), "上田市": (36.4019, 138.2489),
        "岡谷市": (36.0670, 138.0493), "飯田市": (35.5150, 137.8214), "諏訪市": (36.0391, 138.1142),
        "須坂市": (36.6511, 138.3072), "小諸市": (36.3274, 138.4259), "伊那市": (35.8275, 137.9541),
        "駒ヶ根市": (35.7288, 137.9338), "中野市": (36.7420, 138.3695), "大町市": (36.5030, 137.8511),
        "飯山市": (36.8517, 138.3655), "茅野市": (35.9869, 138.1634), "塩尻市": (36.1130, 137.9409),
        "佐久市": (36.2570, 138.4821), "千曲市": (36.5292, 138.1069), "東御市": (36.3353, 138.3768),
        "安曇野市": (36.3323, 137.9157), "小海町": (36.0102, 138.4358), "軽井沢町": (36.3476, 138.6187),
        "御代田町": (36.3263, 138.5204), "立科町": (36.2163, 138.2864), "下諏訪町": (36.0773, 138.0841),
        "富士見町": (35.8907, 138.2570), "辰野町": (35.9734, 137.9893), "箕輪町": (35.8679, 137.9806),
        "飯島町": (35.6841, 137.8920), "山ノ内町": (36.7410, 138.4140), "信濃町": (36.8055, 138.2163),
        "飯綱町": (36.7478, 138.2384)
    },
    "静岡県": {
        "静岡市": (34.9756, 138.3828), "浜松市": (34.7038, 137.7348), "沼津市": (35.1017, 138.8597),
        "熱海市": (35.1000, 139.0667), "三島市": (35.1167, 138.9167), "富士宮市": (35.2167, 138.6167),
        "伊東市": (34.9667, 139.1), "島田市": (34.8333, 138.1833), "富士市": (35.1500, 138.6833),
        "磐田市": (34.7167, 137.85), "焼津市": (34.8667, 138.3167), "掛川市": (34.7667, 138.0167),
        "藤枝市": (34.85, 138.2667), "御殿場市": (35.3, 138.9333), "袋井市": (34.75, 137.9167),
        "下田市": (34.6833, 138.95), "裾野市": (35.1667, 138.9167), "湖西市": (34.7167, 137.55),
        "伊豆市": (34.9833, 138.95), "御前崎市": (34.6167, 138.1333), "菊川市": (34.75, 138.0833),
        "伊豆の国市": (35.0333, 138.9333), "牧之原市": (34.7333, 138.2167)
    },
    "千葉県": {
        "千葉市": (35.6074, 140.1065), "銚子市": (35.7347, 140.8266), "市川市": (35.7222, 139.9231),
        "船橋市": (35.6948, 140.0039), "館山市": (34.9966, 139.8700), "木更津市": (35.375, 139.9242),
        "松戸市": (35.7846, 139.9029), "野田市": (35.9556, 139.8667), "茂原市": (35.4286, 140.2889),
        "成田市": (35.7761, 140.3189), "佐倉市": (35.7225, 140.1067), "東金市": (35.5608, 140.365),
        "旭市": (35.7214, 140.6481), "習志野市": (35.6847, 140.0219), "柏市": (35.8622, 139.9708),
        "勝浦市": (35.152, 140.32), "市原市": (35.5, 140.0889), "流山市": (35.8561, 139.9028),
        "八千代市": (35.7228, 140.0989), "我孫子市": (35.8656, 140.0125), "鴨川市": (35.1, 140.1),
        "鎌ケ谷市": (35.7778, 140.0), "君津市": (35.3333, 139.9), "富津市": (35.2500, 139.85),
        "浦安市": (35.65, 139.9167), "四街道市": (35.6667, 140.1667), "袖ケ浦市": (35.4333, 139.9833),
        "山武市": (35.6, 140.45)
    },
    "埼玉県": {
        "さいたま市": (35.8617, 139.6455), "川越市": (35.9250, 139.4858), "熊谷市": (36.1472, 139.3886),
        "川口市": (35.8083, 139.7194), "行田市": (36.1333, 139.45), "秩父市": (35.9833, 138.4167),
        "所沢市": (35.7917, 139.4667), "飯能市": (35.85, 139.3333), "加須市": (36.1333, 139.6167),
        "本庄市": (36.2333, 139.1833), "東松山市": (36.0333, 139.4), "春日部市": (35.9667, 139.75),
        "狭山市": (35.85, 139.4167), "羽生市": (36.1667, 139.5333), "鴻巣市": (36.0667, 139.5167),
        "深谷市": (36.1833, 139.2833), "上尾市": (35.9667, 139.5833), "草加市": (35.8333, 139.8),
        "越谷市": (35.8903, 139.7903), "蕨市": (35.8167, 139.6833), "戸田市": (35.8167, 139.6667),
        "入間市": (35.8333, 139.3833), "朝霞市": (35.8, 139.6), "志木市": (35.8167, 139.5833),
        "和光市": (35.7833, 139.6167), "新座市": (35.7833, 139.5667), "桶川市": (36.0, 139.55),
        "久喜市": (36.0667, 139.6833), "北本市": (36.0167, 139.5333)
    }
}

def fix_locations():
    print("Fixing store and job template locations...")
    stores = Store.objects.all()
    updated_stores = 0
    updated_templates = 0

    for store in stores:
        pref = store.prefecture.strip() if store.prefecture else ""
        city = store.city.strip() if store.city else ""
        
        # マッピングから座標を取得 (市区町村名が完全に一致する場合)
        coords = MUNI_COORDS.get(pref, {}).get(city)
        if not coords:
            # 「郡」などが付いている場合の曖昧一致
            for muni, pos in MUNI_COORDS.get(pref, {}).items():
                if muni in city or city in muni:
                    coords = pos
                    break
        
        if coords:
            lat, lng = coords
            # すでに近い座標にある場合はスキップ（手動調整済みなどを保護）
            if store.latitude and abs(store.latitude - lat) < 0.001 and store.longitude and abs(store.longitude - lng) < 0.001:
                continue
            
            store.latitude = lat
            store.longitude = lng
            store.save()
            updated_stores += 1
            
            # ひな形も同期
            JobTemplate.objects.filter(store=store).update(latitude=lat, longitude=lng)
            updated_templates += JobTemplate.objects.filter(store=store).count()
            # print(f"  Fixed: {pref}{city}")

    print(f"\nLocation fix complete.")
    print(f"Updated Stores: {updated_stores}")
    print(f"Updated JobTemplates: {updated_templates}")

if __name__ == "__main__":
    fix_locations()
